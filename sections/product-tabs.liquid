<div class="product-tabs">
  <div class="section_product_collection px-10 md:px-40">
    <div class="section_product py-20">
      <div class="section_product_wapper">
        <div class="section_content tabs_panels">
          <div class="section_header text-center mb-10">
              {% if section.settings.heading %}
                  <h2 style="color: {{ section.settings.heading_color }}; font-size: {{ section.settings.heading_size }}px;">
                        {{ section.settings.heading }}
                  </h2>
              {% endif %}

              {% if section.settings.subheading %}
                <p style="color: {{ section.settings.subheading_color }}; font-size: {{ section.settings.subheading_size }}px;">
                   {{ section.settings.subheading }}
                </p>
              {% endif %}
          </div>

          <div class="tabs_panels_collection">
            {% for block in section.blocks %}
              <featured-collection
                 class="block relative {% if forloop.index > 1 %}hidden{% endif %}"
                 data-collection-block
                 {{ block.shopify_attributes }}
              >
                {% if block.settings.collection and forloop.index == 1 %}
                  <div class="flex justify-end mb-3">
                    <button type="button" data-toggle-view class="text-sm font-medium hover:underline">
                      View all
                    </button>
                  </div>
                {% endif %}

                <!-- Wrapper để co giãn và căn giữa cả carousel + thanh scroll -->
                <div class="product-collection-wrapper py-3 flex flex-col items-center">
                  <div class="product-collection flex gap-0 overflow-x-auto scroll-smooth snap-x snap-mandatory scrollbar-hidden">
                    <!-- Banner card -->
                    <div class="snap-start flex-shrink-0 w-[240px] baner-card m-0 p-0">
                      {% render 'banner-card',
                         image: block.settings.banner_image,
                         show_banner: block.settings.show_banner,
                         title: block.settings.banner_heading,
                         button_label: block.settings.button_label,
                         button_url: block.settings.button_url,
                         content_position: block.settings.content_position,
                         button_style: block.settings.button_style
                      %}
                    </div>

                    <!-- Product list - load tất cả sản phẩm (không limit) -->
                    <div class="flex gap-0">
                      {% if block.settings.collection != blank %}
                        {% for product in collections[block.settings.collection].products %}
                          <div class="snap-start flex-shrink-0 w-[240px] h-[470px] product-card m-0 p-0">
                            {% render 'card-product', product: product %}
                          </div>
                        {% endfor %}
                      {% else %}
                        <p class="text-center text-gray-500 flex-shrink-0 w-[350px] h-[470px] flex items-center justify-center">
                          Please select a collection.
                        </p>
                      {% endif %}
                    </div>
                  </div>

                  <!-- Thanh scroll thumb - co theo width carousel -->
                  <div class="scroll-wrapper mt-4 w-full">
                    {% render 'scroll',
                      prev_action: 'scrollProductsLeft()',
                      next_action: 'scrollProductsRight()'
                    %}
                  </div>
                </div>
              </featured-collection>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<style>
  /* Ẩn scrollbar */
  .product-collection {
    scrollbar-width: none;
  }
  .product-collection::-webkit-scrollbar {
    display: none;
  }

  /* Carousel co giãn + giới hạn theo setting */
  .product-collection {
    display: flex;
    gap: 0;
    width: fit-content;
    max-width: calc(240px + {{ section.settings.products_to_show | default: 8 }} * 240px);
    margin: 0 auto;
  }

  /* Thanh scroll thumb co theo width carousel */
  .scroll-wrapper {
    width: 100%;
    max-width: calc(240px + {{ section.settings.products_to_show | default: 8 }} * 240px);
    margin: 0 auto;
    display: flex;
    justify-content: center;
  }

  /* Scroll buttons hover */
  .section_product_collection .btn-slide-hover {
    transition: background-color .25s ease, border-color .25s ease, color .25s ease;
  }
  .section_product_collection .btn-slide-hover:hover {
    background-color: #000;
    border-color: #000;
  }
  .section_product_collection .btn-slide-hover:hover svg {
    color: #fff;
  }

  /* Ẩn hoàn toàn border, shadow và viền mờ của product card */
.product-card {
  border: none !important;
  box-shadow: none !important;
  background: transparent !important;
  outline: none !important;
}

/* Nếu card-product là snippet riêng, đảm bảo override hết */
.card-product,
.product-card img,
.product-card .card__inner,
.product-card .card__content {
  border: none !important;
  box-shadow: none !important;
  outline: none !important;
}

/* Nếu theme dùng class khác (ví dụ .card, .product-item), thêm vào */
.card,
.product-item,
.card__media,
.card__information {
  border: none !important;
  box-shadow: none !important;
}
  /* Responsive mobile */
@media (max-width: 768px) {
  .product-collection,
  .scroll-wrapper {
    max-width: none;      
    width: 100%;              
  }
  .product-card {
    width: 280px !important;   
    height: auto !important;   
  }
  .baner-card {
    width: 280px !important;   
  }
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const btn = document.querySelector('[data-toggle-view]');
    const blocks = document.querySelectorAll('[data-collection-block]');
    let expanded = false;

    if (!btn) return;

    btn.addEventListener('click', () => {
      expanded = !expanded;
      blocks.forEach((block, index) => {
        if (!expanded && index > 0) {
          block.classList.add('hidden');
        } else {
          block.classList.remove('hidden');
        }
      });
      btn.textContent = expanded ? 'View less' : 'View all';
    });
  });
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll("featured-collection").forEach(block => {
    const scroller = block.querySelector(".product-collection");
    const thumb = block.querySelector(".scrollThumb");
    const leftBtn = block.querySelector(".scrollLeft");
    const rightBtn = block.querySelector(".scrollRight");

    if (!scroller || !thumb) return;

    // Hàm cập nhật thumb
    function updateThumb() {
      const maxScroll = scroller.scrollWidth - scroller.clientWidth;

      if (maxScroll <= 0) {
        // Không cần scroll → tô đầy 100%
        thumb.style.width = "100%";
        return;
      }

      // Phần trăm đã scroll
      const scrolledPercent = (scroller.scrollLeft / maxScroll) * 100;

      // Tính phần trăm viewport ban đầu (sản phẩm hiển thị ngay từ đầu)
      const viewportPercent = (scroller.clientWidth / scroller.scrollWidth) * 100;

      // Tô thumb = phần đã scroll + phần viewport ban đầu
      // Nhưng không vượt quá 100%
      const filledPercent = Math.min(scrolledPercent + viewportPercent, 100);

      thumb.style.width = `${filledPercent}%`;
    }

    // Nút Prev / Next
    leftBtn?.addEventListener("click", () => {
      scroller.scrollBy({ left: -300, behavior: "smooth" });
    });

    rightBtn?.addEventListener("click", () => {
      scroller.scrollBy({ left: 300, behavior: "smooth" });
    });

    // Cập nhật khi scroll
    scroller.addEventListener("scroll", updateThumb);

    // Khởi tạo: tô sẵn đoạn viewport ban đầu
    scroller.scrollLeft = 0; // đảm bảo bắt đầu từ đầu
    updateThumb();

    // Cập nhật lại khi resize (mobile ↔ desktop)
    window.addEventListener("resize", updateThumb);
  });
});
</script>

{% schema %}
{
  "name": "Product Tabs",
  "max_blocks": 3,
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Sản phẩm nổi bật"
    },
    {
      "type": "text",
      "id": "subheading",
      "label": "Subheading",
      "default": "Các sản phẩm mới nhất"
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Màu chữ Heading",
      "default": "#111827"
    },
    {
      "type": "color",
      "id": "subheading_color",
      "label": "Màu chữ Subheading",
      "default": "#6B7280"
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Kích thước Heading (px)",
      "min": 16,
      "max": 80,
      "step": 1,
      "default": 32
    },
    {
      "type": "range",
      "id": "subheading_size",
      "label": "Kích thước Subheading (px)",
      "min": 12,
      "max": 60,
      "step": 1,
      "default": 18
    },
    {
      "type": "range",
      "id": "products_to_show",
      "label": "Number of products to show (All tabs)",
      "min": 1,
      "max": 20,
      "step": 1,
      "default": 4
    }
  ],
  "blocks": [
    {
      "type": "collection_block",
      "name": "Collection block",
      "settings": [
        {
          "type": "collection",
          "id": "collection",
          "label": "Select collection"
        },
        {
          "type": "checkbox",
          "id": "show_banner",
          "label": "Show banner",
          "default": true
        },
        {
          "type": "image_picker",
          "id": "banner_image",
          "label": "Banner image"
        },
        {
          "type": "text",
          "id": "banner_heading",
          "label": "Banner heading",
          "default": "Healthy Lifestyle"
        },
        {
          "type": "text",
          "id": "button_label",
          "label": "Button text",
          "default": "Shop Now"
        },
        {
          "type": "url",
          "id": "button_url",
          "label": "Button link"
        },
        {
          "type": "select",
          "id": "content_position",
          "label": "Content position",
          "default": "center",
          "options": [
            { "label": "Top", "value": "top" },
            { "label": "Bottom", "value": "bottom" },
            { "label": "Left", "value": "left" },
            { "label": "Right", "value": "right" },
            { "label": "Center", "value": "center" }
          ]
        },
        {
          "type": "select",
          "id": "button_style",
          "label": "Button style",
          "default": "normal",
          "options": [
            { "label": "Normal", "value": "normal" },
            { "label": "Underline", "value": "underline" },
            { "label": "Hover effect", "value": "hover" }
          ]
        }
      ]
    }
  ],
  "presets": [
    {
      "name": "Product Tabs Section"
    }
  ]
}
{% endschema %}